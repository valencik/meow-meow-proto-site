<!DOCTYPE html>
<html data-bulma-theme="light">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" href="../img/favicon.ico" sizes="32x32">
  <link rel="icon" href="../img/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="../img/apple-touch-icon.png">

  <script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/js/all.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/fontawesome.min.css"
    rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:500">

  <link rel="stylesheet" href="../main.css">
  <link rel="stylesheet" href="../css/code.css">
  <link rel="stylesheet" href="../search/docs.css">
  <script src="../main.js"></script>

  <title>Testing in the wild</title>
</head>

<body class="bulma-is-flex bulma-is-flex-direction-column">
  <nav class="bulma-navbar" role="navigation" aria-label="main navigation">
  <div class="bulma-navbar-brand">
    <a class="bulma-navbar-item" href="../">
      <img src="../img/logo.svg" />
    </a>

    <a role="button" class="bulma-navbar-burger" aria-label="menu" aria-expanded="false" data-target="navMenu"
      onClick="handleBurgerClick(this)">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </a>
  </div>
  <div class="bulma-navbar-menu" id="navMenu">
    <div class="bulma-navbar-start">

    </div>
    <div class="bulma-navbar-end">
      <div class="bulma-navbar-item"><a class="bulma-button bulma-is-rounded bulma-is-link">Get Started</a></div>
      <div class="bulma-navbar-item"><a class="bulma-button bulma-is-text">Learn</a></div>
      <div class="bulma-navbar-item"><a class="bulma-button bulma-is-text">Community</a></div>
      <div class="bulma-navbar-item"><a class="bulma-button bulma-is-text" href="../foundation/">Foundation</a></div>
      <div class="bulma-navbar-item"><a class="bulma-button bulma-is-text" href="index.html">Blog</a></div>
      <div class="bulma-navbar-item">
        <a id="search-top-bar" class="bulma-button bulma-is-text" aria-label="Search" onclick="showSearchModal()">
          <span class="bulma-icon bulma-is-small">
            <i class="fas fa-magnifying-glass"></i>
          </span>
        </a>
      </div>
    </div>
  </div>
</nav>

<!-- Search Modal -->
<div id="search-modal" class="bulma-modal bulma-is-justify-content-flex-start bulma-pt-6 bulma-pb-6">
  <div class="bulma-modal-background bulma-is-align-items-flex-start" onclick="hideSearchModal()"></div>
  <div class="bulma-modal-card">
    <header class="bulma-modal-card-head">
      <p class="bulma-control bulma-has-icons-left bulma-is-flex-grow-1">
        <input id="search-input" class="bulma-input bulma-is-medium bulma-is-primary" type="search" autocomplete="off" oninput="onSearchInput(event)">
        <span class="bulma-icon bulma-is-left bulma-has-text-primary">
          <i class="fas fa-magnifying-glass"></i>
        </span>
      </p>
    </header>
    <section id="search-results" class="bulma-modal-card-body">
    </section>
    <footer class="bulma-modal-card-foot bulma-is-justify-content-space-between">
      <span class="bulma-has-text-grey bulma-is-size-7">
        <kbd class="bulma-tag">/</kbd> to open search &nbsp;
        <kbd class="bulma-tag">Esc</kbd> to close
      </span>
    </footer>
  </div>
</div>

  <main class="bulma-is-flex-grow-1">
    
<section class="bulma-hero bulma-is-link bulma-is-bold">
  <div class="bulma-hero-body bulma-container bulma-is-max-desktop">
    <p class="bulma-title">Testing in the wild</p>
    <p class="blog-post-byline bulma-has-text-light bulma-subtitle">
      by
      
        Eric Torreborre<span class="delimiter">,</span><span class="last-delimiter"> &</span>
      
      on July 12, 2018
    </p>
     
      <span class="bulma-tag">technical</span>
     
  </div>
</section>
<div class="bulma-section bulma-container bulma-is-max-desktop">
  <div class="blog-post bulma-content">
    <h1 id="testing-in-the-wild" class="title">Testing in the wild</h1>
    <p>Writing tests seems like a wonderful idea in theory but real systems can be a real pain to test. Today I want to show a few tips on how to
     use <a href="http://specs2.org">specs2</a> + <a href="http://www.scalacheck.org">ScalaCheck</a> to make some real-world testing somewhat bearable.</p>
    <p>I am currently refactoring a big piece of code. Such refactoring is more like a small rewrite and some of our previous tests also have to be
     rewritten from scratch. I will try to introduce you to the problem first.</p>
    
    <h3 id="creating-articles" class="section"><a class="anchor-link" href="#creating-articles"><code class="fas fa-link fa-sm"></code></a>Creating articles</h3>
    <p>The system-du-jour is called &quot;Panda&quot; (we have animal names for many of our services in my team) and is tasked with the creation of articles
     on our legacy platform. An article is already a complicated beast. We have 3 levels of descriptions:</p>
    <ul>
      <li>Model: the description for a pair of RunFast shoes, with the brand, the gender it applies to, the size chart it uses and so on</li>
    </ul>
    <ul>
      <li>Config: the description for a specific combination of colours - black RunFast -, images, material,... There can be several configs per model</li>
    </ul>
    <ul>
      <li>
        <p>Simple: the description of a specific size - 37, 38, 39 -, price, stock, EAN (European Article Number),... There can be several simples
        per config</p>
        <p>This data can be created in our legacy catalog by calling a bunch of SOAP (yes you read that right) APIs and getting back, at each level,
        some identifiers for the model, the configs, the simples.</p>
        <p>This in itself can already be quite complicated and the creation of an article could fail in many ways. But it gets a lot more complex
        considering that:</p>
        <ol class="arabic">
          <li>
            <p>we need the service to be idempotent and not try to recreate an existing model/config/simple twice if we receive the same event twice
            (we are using Kafka as our events system)</p>
          </li>
          <li>
            <p>the articles sent by a merchant can be created incrementally, so some parts of the model/config/simple might have been already created
            in a previous call</p>
          </li>
          <li>
            <p>we are not the only ones creating articles in the system! Indeed, our team creates articles coming from external merchants but there is
            also an internal &quot;wholesale&quot; department buying their own articles and creating them in the catalog. In that case a merchant might add
            a new config to an existing model or some simples to an existing config</p>
          </li>
          <li>
            <p>any step in the process could break and we have no support for transactions making sure that everything is created at once</p>
          </li>
        </ol>
        <p>So many things which can go wrong, how would you go about testing it?</p>
      </li>
    </ul>
    
    <h3 id="combinations-the-key-to-testing" class="section"><a class="anchor-link" href="#combinations-the-key-to-testing"><code class="fas fa-link fa-sm"></code></a>Combinations, the key to testing</h3>
    <p>After I started rewriting the tests I realized that our current approach was barely scratching the surface of all the possible combinations.
     In a similar case your first thought should be &quot;ScalaCheck&quot;! But this time I am going to use ScalaCheck with a twist. Instead of only modelling
     input data (model/config/simples) I am also modelling the system state:</p>
    <ul>
      <li>we have a &quot;mapping table&quot; to store merchant articles that have already been created. In which states can it be?</li>
    </ul>
    <ul>
      <li>
        <p>the legacy catalog can also be in many different states: does a particular model/config/simple already exist or not?</p>
        <p>If we translate this into a specs2 + ScalaCheck specification, we get a property like this:</p>
      </li>
    </ul>
    <pre><code class="nohighlight"><span class="keyword">class</span><span> </span><span class="type-name">ArticleServiceSpec</span><span> </span><span class="keyword">extends</span><span> </span><span class="type-name">Specification</span><span> </span><span class="keyword">with</span><span> </span><span class="type-name">ScalaCheck</span><span> { </span><span class="keyword">def</span><span> </span><span class="declaration-name">is</span><span> = </span><span class="identifier">s2</span><span class="string-literal">&quot;&quot;&quot;

  &lt;insert long description of the problem and what we want to test&gt;

  run tests for model creation $modelCreation

&quot;&quot;&quot;</span><span>

  </span><span class="keyword">def</span><span> </span><span class="declaration-name">modelCreation</span><span> = </span><span class="identifier">prop</span><span> { (</span><span class="identifier">reviewed</span><span>: </span><span class="type-name">Article</span><span>, </span><span class="identifier">catalog</span><span>: </span><span class="type-name">TestCatalog</span><span>, </span><span class="identifier">mappings</span><span>: </span><span class="type-name">TestMappings</span><span>) =&gt;

    </span><span class="identifier">ok</span><span> </span><span class="comment">// for now
</span><span>

  }.</span><span class="identifier">setGen1</span><span>(</span><span class="identifier">genArticleOneConfig</span><span>)
}</span></code></pre>
    <p>We are creating a ScalaCheck property, with a specs2 method <code>prop</code> which gives us some additional power over row ScalaCheck properties.
     One thing we do here is to restrict the kind of generated <code>Article</code> to articles containing only one new configuration because we want to
      focus first on all the possible cases of model creation. So we pass a specific generator to the property, just for the first argument
      with <code>setGen1</code>.</p>
    <p>Then, as you can see above, we return <code>ok</code> which is a specs2 result. This is because <code>prop</code> allows us to return anything that specs2 recognizes
      as a <code>Result</code> (with the <code>org.specs2.execute.AsResult</code> typeclass) and then we are not limited to booleans in our ScalaCheck properties but
      we can use specs2 matchers as well (we are going use this in the next step).</p>
    <p>Now, for testing we need to do the following:</p>
    <ol class="arabic">
      <li>capture the state before the article creation</li>
    </ol>
    <ol class="arabic">
      <li>execute the article creation</li>
    </ol>
    <ol class="arabic">
      <li>capture the state after the article creation</li>
    </ol>
    <ol class="arabic">
      <li>compare the resulting state to expected values</li>
    </ol>
    <pre><code class="nohighlight"><span>  </span><span class="keyword">val</span><span> </span><span class="identifier">before</span><span> = </span><span class="identifier">createBeforeState</span><span>(</span><span class="identifier">reviewed</span><span>, </span><span class="identifier">catalog</span><span>, </span><span class="identifier">mappings</span><span>)
  </span><span class="keyword">val</span><span> </span><span class="identifier">result</span><span> = </span><span class="identifier">run</span><span>(</span><span class="identifier">createService</span><span>(</span><span class="identifier">catalog</span><span>, </span><span class="identifier">mappings</span><span>).</span><span class="identifier">createArticles</span><span>[</span><span class="type-name">R</span><span>](</span><span class="identifier">reviewed</span><span>))
  </span><span class="keyword">val</span><span> </span><span class="identifier">after</span><span>  = </span><span class="identifier">createAfterState</span><span>(</span><span class="identifier">reviewed</span><span>, </span><span class="identifier">catalog</span><span>, </span><span class="identifier">mappings</span><span>, </span><span class="identifier">result</span><span>)</span></code></pre>
    <p>What are <code>BeforeState</code> and <code>AfterState</code>? They are custom case classes modelling the variables we are interested in:</p>
    <pre><code class="nohighlight"><span> </span><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">BeforeState</span><span>(
   </span><span class="identifier">modelIdProvided</span><span>:       </span><span class="type-name">Boolean</span><span>,
   </span><span class="identifier">modelNeedsToBeCreated</span><span>: </span><span class="type-name">Boolean</span><span>,
   </span><span class="identifier">modelExistsInCatalog</span><span>:  </span><span class="type-name">Boolean</span><span>,
   </span><span class="identifier">mappingExists</span><span>:         </span><span class="type-name">Boolean</span><span>)

 </span><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">AfterState</span><span>(
   </span><span class="identifier">modelExistsInCatalog</span><span>: </span><span class="type-name">Boolean</span><span>,
   </span><span class="identifier">mappingExists</span><span>:        </span><span class="type-name">Boolean</span><span>,
   </span><span class="identifier">exception</span><span>:            </span><span class="type-name">Option</span><span>[</span><span class="type-name">Throwable</span><span>])</span></code></pre>
    <p>The first 2 variables of <code>BeforeState</code> are a bit curious. The first one gives us a <code>ModelId</code> if upstream systems know that a model already
      exist. Then how could <code>modelNeedsToBeCreated</code> be true? Well, the events we receive don&#39;t rule out this possibility. This is the
      current state of our domain data and arguably we should model things differently and reject malformed events right away. This is where the
      saying <a href="https://www.obeythetestinggoat.com/book/chapter_purist_unit_tests.html#_listen_to_your_tests_ugly_tests_signal_a_need_to_refactor">&quot;Listen to your tests&quot;</a> comes in :-).</p>
    <p>If we count the number of combinations we end up with 16 possibilities for our &quot;before state&quot; and 8 possible outcomes. How can we represent
       all those combinations in our test?</p>
    
    <h3 id="datatables" class="section"><a class="anchor-link" href="#datatables"><code class="fas fa-link fa-sm"></code></a>DataTables</h3>
    <p>Specs2 offers to possibility to create tables of data directly inside the code for better readability of actual and expected values
     when you have lots of different possible combinations. Here is what we can do here</p>
    <pre><code class="nohighlight"><span>  </span><span class="keyword">val</span><span> </span><span class="identifier">results</span><span> =
  </span><span class="string-literal">&quot;#&quot;</span><span> | </span><span class="string-literal">&quot;model-id&quot;</span><span> | </span><span class="string-literal">&quot;create&quot;</span><span> | </span><span class="string-literal">&quot;in catalog&quot;</span><span> | </span><span class="string-literal">&quot;mapping&quot;</span><span> || </span><span class="string-literal">&quot;in catalog&quot;</span><span>  | </span><span class="string-literal">&quot;mapping&quot;</span><span> | </span><span class="string-literal">&quot;exception&quot;</span><span> | </span><span class="string-literal">&quot;comment&quot;</span><span> |
  </span><span class="number-literal">1</span><span>   !  </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">true</span><span>     ! </span><span class="boolean-literal">true</span><span>         ! </span><span class="boolean-literal">true</span><span>      !! </span><span class="boolean-literal">true</span><span>          ! </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">false</span><span>       ! </span><span class="string-literal">&quot;no model is created, because it can be found in the catalog, creation data is ignored&quot;</span><span> |
  </span><span class="number-literal">2</span><span>   !  </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">true</span><span>     ! </span><span class="boolean-literal">true</span><span>         ! </span><span class="boolean-literal">false</span><span>     !! </span><span class="boolean-literal">true</span><span>          ! </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">false</span><span>       ! </span><span class="string-literal">&quot;we just updated the mapping&quot;</span><span> |
  </span><span class="number-literal">3</span><span>   !  </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">true</span><span>     ! </span><span class="boolean-literal">false</span><span>        ! </span><span class="boolean-literal">true</span><span>      !! </span><span class="boolean-literal">false</span><span>         ! </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">true</span><span>        ! </span><span class="string-literal">&quot;the config creation must fail, no existing model&quot;</span><span> |
  </span><span class="number-literal">4</span><span>   !  </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">true</span><span>     ! </span><span class="boolean-literal">false</span><span>        ! </span><span class="boolean-literal">false</span><span>     !! </span><span class="boolean-literal">true</span><span>          ! </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">false</span><span>       ! </span><span class="string-literal">&quot;the given model-id is ignored (a warning is logged)&quot;</span><span> |
  </span><span class="number-literal">5</span><span>   !  </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">false</span><span>    ! </span><span class="boolean-literal">true</span><span>         ! </span><span class="boolean-literal">true</span><span>      !! </span><span class="boolean-literal">true</span><span>          ! </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">false</span><span>       ! </span><span class="string-literal">&quot;no model is created, because it can be found in the catalog&quot;</span><span> |
  </span><span class="number-literal">6</span><span>   !  </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">false</span><span>    ! </span><span class="boolean-literal">true</span><span>         ! </span><span class="boolean-literal">false</span><span>     !! </span><span class="boolean-literal">true</span><span>          ! </span><span class="boolean-literal">false</span><span>     ! </span><span class="boolean-literal">false</span><span>       ! </span><span class="string-literal">&quot;the mappings are not updated because we did not create the model&quot;</span><span> |
  </span><span class="number-literal">7</span><span>   !  </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">false</span><span>    ! </span><span class="boolean-literal">false</span><span>        ! </span><span class="boolean-literal">true</span><span>      !! </span><span class="boolean-literal">false</span><span>         ! </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">true</span><span>        ! </span><span class="string-literal">&quot;no corresponding model in the catalog&quot;</span><span> |
  </span><span class="number-literal">8</span><span>   !  </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">false</span><span>    ! </span><span class="boolean-literal">false</span><span>        ! </span><span class="boolean-literal">false</span><span>     !! </span><span class="boolean-literal">false</span><span>         ! </span><span class="boolean-literal">false</span><span>     ! </span><span class="boolean-literal">true</span><span>        ! </span><span class="string-literal">&quot;no corresponding model in the catalog&quot;</span><span> |
  </span><span class="number-literal">9</span><span>   !  </span><span class="boolean-literal">false</span><span>     ! </span><span class="boolean-literal">true</span><span>     ! </span><span class="boolean-literal">true</span><span>         ! </span><span class="boolean-literal">true</span><span>      !! </span><span class="boolean-literal">true</span><span>          ! </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">false</span><span>       ! </span><span class="string-literal">&quot;we use the mapping table to retrieve the model id and the catalog for the model&quot;</span><span> |
  </span><span class="number-literal">10</span><span>  !  </span><span class="boolean-literal">false</span><span>     ! </span><span class="boolean-literal">true</span><span>     ! </span><span class="boolean-literal">true</span><span>         ! </span><span class="boolean-literal">false</span><span>     !! </span><span class="boolean-literal">true</span><span>          ! </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">false</span><span>       ! </span><span class="string-literal">&quot;in this case the model already exists in the catalag but we have no way to know&quot;</span><span> |
  </span><span class="number-literal">11</span><span>  !  </span><span class="boolean-literal">false</span><span>     ! </span><span class="boolean-literal">true</span><span>     ! </span><span class="boolean-literal">false</span><span>        ! </span><span class="boolean-literal">true</span><span>      !! </span><span class="boolean-literal">false</span><span>         ! </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">true</span><span>        ! </span><span class="string-literal">&quot;the mapping exists but not the data in the catalog&quot;</span><span> |
  </span><span class="number-literal">12</span><span>  !  </span><span class="boolean-literal">false</span><span>     ! </span><span class="boolean-literal">true</span><span>     ! </span><span class="boolean-literal">false</span><span>        ! </span><span class="boolean-literal">false</span><span>     !! </span><span class="boolean-literal">true</span><span>          ! </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">false</span><span>       ! </span><span class="string-literal">&quot;regular model + config creation case&quot;</span><span> |
  </span><span class="number-literal">13</span><span>  !  </span><span class="boolean-literal">false</span><span>     ! </span><span class="boolean-literal">false</span><span>    ! </span><span class="boolean-literal">true</span><span>         ! </span><span class="boolean-literal">true</span><span>      !! </span><span class="boolean-literal">true</span><span>          ! </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">true</span><span>        ! </span><span class="string-literal">&quot;there is no model id and no creation data&quot;</span><span> |
  </span><span class="number-literal">14</span><span>  !  </span><span class="boolean-literal">false</span><span>     ! </span><span class="boolean-literal">false</span><span>    ! </span><span class="boolean-literal">true</span><span>         ! </span><span class="boolean-literal">false</span><span>     !! </span><span class="boolean-literal">true</span><span>          ! </span><span class="boolean-literal">false</span><span>     ! </span><span class="boolean-literal">true</span><span>        ! </span><span class="string-literal">&quot;the model exists in the catalog but we have no way to retrieve it&quot;</span><span> |
  </span><span class="number-literal">15</span><span>  !  </span><span class="boolean-literal">false</span><span>     ! </span><span class="boolean-literal">false</span><span>    ! </span><span class="boolean-literal">false</span><span>        ! </span><span class="boolean-literal">true</span><span>      !! </span><span class="boolean-literal">false</span><span>         ! </span><span class="boolean-literal">true</span><span>      ! </span><span class="boolean-literal">true</span><span>        ! </span><span class="string-literal">&quot;model id found in the mapping but not in the catalog&quot;</span><span> |
  </span><span class="number-literal">16</span><span>  !  </span><span class="boolean-literal">false</span><span>     ! </span><span class="boolean-literal">false</span><span>    ! </span><span class="boolean-literal">false</span><span>        ! </span><span class="boolean-literal">false</span><span>     !! </span><span class="boolean-literal">false</span><span>         ! </span><span class="boolean-literal">false</span><span>     ! </span><span class="boolean-literal">true</span><span>        ! </span><span class="string-literal">&quot;not enough data to create the model nor the mapping&quot;</span><span>

 </span><span class="identifier">checkState</span><span>(</span><span class="identifier">before</span><span>, </span><span class="identifier">after</span><span>, </span><span class="identifier">parseTable</span><span>(</span><span class="identifier">results</span><span>))</span></code></pre>
    <p>This looks like a strange piece of code but this is actually all valid Scala syntax! <code>results</code> is a specs2 <code>DataTable</code> created out of:</p>
    <ul>
      <li>a header where column names are separated with <code>|</code></li>
    </ul>
    <ul>
      <li>rows that are also separated with <code>|</code></li>
    </ul>
    <ul>
      <li>cells on each row, separated with <code>!</code></li>
    </ul>
    <p>We can also use <code>||</code> and <code>!!</code> as separators and we use this possibility here to visually distinguish input columns from expected results
      columns.</p>
    
    <h3 id="running-the-tests" class="section"><a class="anchor-link" href="#running-the-tests"><code class="fas fa-link fa-sm"></code></a>Running the tests</h3>
    <p>The table above is like a big &quot;truth table&quot; for all our input conditions. Running a test consists in:</p>
    <ol class="arabic">
      <li>using the &#39;before state&#39; to locate one of the row</li>
    </ol>
    <ol class="arabic">
      <li>getting the expected &#39;after state&#39; from the expected columns</li>
    </ol>
    <ol class="arabic">
      <li>comparing the actual &#39;after state&#39; with the expected one</li>
    </ol>
    <p>The funny thing is that before executing the test I did not exactly know what the code would actually do! So I just let the test guide me.
    I put some expected values, run the test and in case of a failure, inspect the input values, think hard about why the code is not behaving the
    way I think it should.</p>
    <p>One question comes to mind: since this is a ScalaCheck property, how can we be sure we hit all the cases in the table? The first thing we
    can do is to massively increase the number of tests that are going to be executed for this property, like 10000. With specs2 you have many
    ways to do this. You can set the <code>minTestsOk</code> ScalaCheck property directly in the code:</p>
    <pre><code class="nohighlight"><span class="keyword">def</span><span> </span><span class="declaration-name">modelCreation</span><span> = </span><span class="identifier">prop</span><span> { (</span><span class="identifier">reviewed</span><span>: </span><span class="type-name">Article</span><span>, </span><span class="identifier">catalog</span><span>: </span><span class="type-name">TestCatalog</span><span>, </span><span class="identifier">mappings</span><span>: </span><span class="type-name">TestMappings</span><span>) =&gt;
 ...
}.</span><span class="identifier">setGen1</span><span>(</span><span class="identifier">genArticleOneConfig</span><span>).</span><span class="identifier">set</span><span>(</span><span class="identifier">minTestsOk</span><span> = </span><span class="number-literal">10000</span><span>)</span></code></pre>
    <p>But you can also do it from sbt:</p>
    <pre><code>sbt&gt; testOnly *ArticleServiceSpec -- scalacheck.mintestsok 10000</code></pre>
    <p>This is quite cool because this means that you don&#39;t have to recompile the code if you just want to run a ScalaCheck property with more tests.</p>
    
    <h3 id="checking-the-results" class="section"><a class="anchor-link" href="#checking-the-results"><code class="fas fa-link fa-sm"></code></a>Checking the results</h3>
    <p>As I wrote, when a specific combination would fail I had to inspect the inputs/outputs and think hard, maybe my expectations are wrong and
    I needed to change the expected values? To this end I added a &quot;line number&quot; column to the table and reported it in the result:</p>
    <pre><code> [error]  &gt; On line 6
 [error]
 [error]  Before
 [error]    model id set:             true
 [error]    model creation data set:  false
 [error]    model exists in catalog : true
 [error]    model id mapping exists:  false
 [error]
 [error]  After
 [error]    model exists in catalog:  true
 [error]      expected:               true
 [error]
 [error]    model id mapping exists:  false
 [error]      expected:               false
 [error]
 [error]    exception thrown:         None
 [error]      expected:               Some</code></pre>
    <p>This reporting is all done in the <code>checkState</code> method which is:</p>
    <ul>
      <li>doing the comparison between actual and expected values</li>
    </ul>
    <ul>
      <li>displaying the before / after states</li>
    </ul>
    <ul>
      <li>
        <p>displaying the difference between expected and actual values</p>
        <p>Actually I even enhanced the display of actual/expected values by coloring them in green or red in the console, using one of specs2 helper
        classes <code>org.specs2.text.AnsiColors</code>:</p>
      </li>
    </ul>
    <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">specs2</span><span>.</span><span class="identifier">text</span><span>.</span><span class="type-name">AnsiColors</span><span>

</span><span class="keyword">def</span><span> </span><span class="declaration-name">withColor</span><span>[</span><span class="type-name">A</span><span>](</span><span class="identifier">actual</span><span>: </span><span class="type-name">A</span><span>, </span><span class="identifier">expected</span><span>: </span><span class="type-name">A</span><span>, </span><span class="identifier">condition</span><span>: (</span><span class="type-name">A</span><span>, </span><span class="type-name">A</span><span>) =&gt; </span><span class="type-name">Boolean</span><span> = (</span><span class="identifier">a</span><span>:</span><span class="type-name">A</span><span>, </span><span class="identifier">e</span><span>:</span><span class="type-name">A</span><span>) =&gt; </span><span class="identifier">a</span><span> == </span><span class="identifier">e</span><span>): </span><span class="type-name">String</span><span> =
  </span><span class="comment">// color the expected value in green or red, depending on the test success
</span><span>  </span><span class="identifier">color</span><span>(</span><span class="identifier">expected</span><span>.</span><span class="identifier">toString</span><span>, </span><span class="keyword">if</span><span> (</span><span class="identifier">condition</span><span>(</span><span class="identifier">actual</span><span>, </span><span class="identifier">expected</span><span>)) </span><span class="identifier">green</span><span> </span><span class="keyword">else</span><span> </span><span class="identifier">red</span><span>)

</span><span class="identifier">withColor</span><span>(</span><span class="identifier">after</span><span>.</span><span class="identifier">modelExistsInCatalog</span><span>, </span><span class="identifier">expected</span><span>.</span><span class="identifier">modelExistsInCatalog</span><span>)</span></code></pre>
    <p>Both the line numbering and the coloring really helps in fixing issues fast!</p>
    
    <h3 id="replaying-tests" class="section"><a class="anchor-link" href="#replaying-tests"><code class="fas fa-link fa-sm"></code></a>Replaying tests</h3>
    <p>A vexing issue with property-based testing is that being random, it will generate random failures every time you re-run a property. So you
    can&#39;t re-run a property with the exact same input data. But that was before ScalaCheck 1.14! Now we can pass the seed that is used by the random
     generator to faithfully re-run a failing test. Indeed when a property fails, specs2 will display the current seed value:</p>
    <pre><code>[error]  The seed is 1tRQ5-jdfEABEXz1y62Cs0C4vNJQKyXps9eWvbjJPSI=</code></pre>
    <p>And you can pass this value on the command line to re-run with exactly the failing input data:</p>
    <pre><code>sbt&gt; testOnly *ArticleServiceSpec -- scalacheck.seed 1tRQ5-jdfEABEXz1y62Cs0C4vNJQKyXps9eWvbjJPSI=</code></pre>
    <p>This is super-convenient for debugging!</p>
    
    <h3 id="comments" class="section"><a class="anchor-link" href="#comments"><code class="fas fa-link fa-sm"></code></a>Comments</h3>
    <p>Finally when a given row in the table passes, there is a <code>comment</code> column to register the reason for this specific outcomes so that future
    generations have a sense of <em>why</em> the code is behaving that way. In that sense this whole approach is a bit like having &quot;golden tests&quot; which
    are capturing the behaviour of the system as a series of examples</p>
    
    <h3 id="conclusion" class="section"><a class="anchor-link" href="#conclusion"><code class="fas fa-link fa-sm"></code></a>Conclusion</h3>
    <p>This post shows how we can leverage features from both specs2 and ScalaCheck to make our tests more exhaustive, more readable, more debuggable.
    The reality is still more complicated than this:</p>
    <ul>
      <li>the total number of combinations would make our table very large. So there are actually several tables (one for model creation, one for
      config creation,...) where we assume that some variables are fixed while others can move</li>
    </ul>
    <ul>
      <li>specs2 datatables are currently limited to 10 columns. The <code>DataTable</code> code is actually code generated and the latest version only has 10
      columns. One easy first step would be to generate more code (and go up to the magic 22 number for example) or to re-implement this functionality
      as some kind of HList</li>
    </ul>
    <ul>
      <li>the input state is not trivial to generate because the objects are dependent. The <code>ModelId</code> of a generated model must be exactly the same
      as the one used in the <code>Mappings</code> component to register that a model has already been created. So in reality the 2 generators for <code>Article</code> and
      <code>Mappings</code> are not totally independent</li>
    </ul>
    <ul>
      <li>the <code>Arbitrary</code> instance for <code>Article</code> can give us articles with 5 <code>Configs</code> and 10 <code>Simples</code> but for this test, one <code>Config</code> and one <code>Simple</code>
      are enough. Unfortunately we miss a nice language to express those generation condition and easily tweak the default <code>Arbitrary[Article]</code> (I
      will explore a solution to this problem during the next Haskell eXchange)</li>
    </ul>
    <ul>
      <li>why are we even using ScalaCheck to generate all the cases since we already statically know all the possible 16 input conditions? We could
      invert this relation and have a ScalaCheck property generated for each row of the datatable with some arbitrary data for the model (and some
      fixed data given by the current row). This would not necessarily lead to easier code to implement.</li>
    </ul>
    <p>Anyway despite those remaining questions and issues I hope this post gives you some new ideas on how to be more effective when writing tests
      with specs2 and ScalaCheck, please comment on your own experiments!</p>
  </div>
</div>
<div class="bulma-section bulma-container bulma-is-max-desktop">
  <div class="bulma-columns">
    
    <div class="bulma-column">
      <article class="bulma-media">
  
  <figure class="bulma-media-left">
    <p class="bulma-image bulma-is-64x64">
      <img class="bulma-is-rounded" src="https://github.com/etorreborre.png" />
    </p>
  </figure>
  
  <div class="bulma-media-content">
    <div class="bulma-content">
      <p>
        <strong>Eric Torreborre</strong>
        
      </p>
    </div>
    <nav class="bulma-level bulma-is-align-items-start">
      <div class="bulma-level-left bulma-is-flex-direction-row">
        
        
        <a class="bulma-level-item" href="http://github.com/etorreborre">
          <span class="bulma-icon bulma-is-small"><i class="fab fa-github"></i></span>
        </a>
        
        
        
        
      </div>
    </nav>
  </div>
</article>

    </div>
    
  </div>
</div>


  </main>
  <footer class="bulma-footer">
  <div class="bulma-columns">
    <div class="bulma-column bulma-is-half">
      Copyright 2026 Typelevel Foundation and <a href="https://github.com/typelevel/typelevel.github.com/graphs/contributors">contributors</a>.
      Licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> unless <a href="../colophon.html#license">noted otherwise</a>.
    </div>
    <div class="bulma-column">
      <ul>
        <li><a href="../projects/">Project Index</a></li>
        <li><a href="#">Documentation</a></li>
        <li><a href="#">Contributing</a></li>
      </ul>
    </div>
    <div class="bulma-column">
      <ul>
        <li><a href="../code-of-conduct/">Code of Conduct</a></li>
        <li><a href="../security.html">Security Policy</a></li>
        <li><a href="../colophon.html">Colophon</a></li>
      </ul>
    </div>
  </div>
  <div class="bulma-has-text-centered">
    <div>Find us on ...</div>
    <div>
      <a class="bulma-icon bulma-is-large bulma-has-text-current" href="https://github.com/typelevel">
        <i class="fab fa-github fa-2x"></i>
      </a>
      <a class="bulma-icon bulma-is-large bulma-has-text-current" href="https://discord.gg/pey2hnSQGS">
        <i class="fab fa-discord fa-2x"></i>
      </a>
      <a class="bulma-icon bulma-is-large bulma-has-text-current" href="https://bsky.app/profile/typelevel.org">
        <i class="fab fa-bluesky fa-2x"></i>
      </a>
      <a class="bulma-icon bulma-is-large bulma-has-text-current" href="https://fosstodon.org/@typelevel">
        <i class="fab fa-mastodon fa-2x"></i>
      </a>
      <a class="bulma-icon bulma-is-large bulma-has-text-current" href="https://www.youtube.com/@typelevel">
        <i class="fab fa-youtube fa-2x"></i>
      </a>
      <a class="bulma-icon bulma-is-large bulma-has-text-current"
        href="https://linkedin.com/company/typelevel-foundation">
        <i class="fab fa-linkedin fa-2x"></i>
      </a>
    </div>
  </div>
</footer>

</body>

</html>

