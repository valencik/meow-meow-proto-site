<!DOCTYPE html>
<html data-bulma-theme="light">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="icon" href="../img/favicon.ico" sizes="32x32">
  <link rel="icon" href="../img/favicon.svg" type="image/svg+xml">
  <link rel="apple-touch-icon" href="../img/apple-touch-icon.png">

  <script src="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/js/all.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@7.1.0/css/fontawesome.min.css"
    rel="stylesheet">
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Fira+Mono:500">

  <link rel="stylesheet" href="../main.css">
  <link rel="stylesheet" href="../css/code.css">
  <link rel="stylesheet" href="../search/docs.css">
  <script src="../main.js"></script>

  <title>Error handling in Http4s with classy optics – Part 2</title>
</head>

<body>
  <nav class="bulma-navbar" role="navigation" aria-label="main navigation">
  <div class="bulma-navbar-brand">
    <a class="bulma-navbar-item" href="../">
      <img src="../img/logo.svg" />
    </a>

    <a role="button" class="bulma-navbar-burger" aria-label="menu" aria-expanded="false" data-target="navMenu"
      onClick="handleBurgerClick(this)">
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
      <span aria-hidden="true"></span>
    </a>
  </div>
  <div class="bulma-navbar-menu" id="navMenu">
    <div class="bulma-navbar-start">

    </div>
    <div class="bulma-navbar-end">
      <div class="bulma-navbar-item"><a class="bulma-button bulma-is-rounded bulma-is-link">Get Started</a></div>
      <div class="bulma-navbar-item"><a class="bulma-button bulma-is-white">Learn</a></div>
      <div class="bulma-navbar-item"><a class="bulma-button bulma-is-white">Community</a></div>
      <div class="bulma-navbar-item"><a class="bulma-button bulma-is-white">Foundation</a></div>
      <div class="bulma-navbar-item"><a class="bulma-button bulma-is-white" href="index.html">Blog</a>
      </div>
      <div class="bulma-navbar-item">
        <a id="search-top-bar" class="bulma-button bulma-is-white" aria-label="Search" onclick="showSearchModal()">
          <span class="bulma-icon bulma-is-small">
            <i class="fas fa-magnifying-glass"></i>
          </span>
        </a>
      </div>
    </div>
  </div>
</nav>

<!-- Search Modal -->
<div id="search-modal" class="bulma-modal bulma-is-justify-content-flex-start bulma-pt-6 bulma-pb-6">
  <div class="bulma-modal-background bulma-is-align-items-flex-start" onclick="hideSearchModal()"></div>
  <div class="bulma-modal-card">
    <header class="bulma-modal-card-head">
      <p class="bulma-control bulma-has-icons-left bulma-is-flex-grow-1">
        <input id="search-input" class="bulma-input bulma-is-medium" type="search" autocomplete="off" oninput="onSearchInput(event)">
        <span class="bulma-icon bulma-is-left">
          <i class="fas fa-magnifying-glass"></i>
        </span>
      </p>
    </header>
    <section id="search-results" class="bulma-modal-card-body">
    </section>
    <footer class="bulma-modal-card-foot bulma-is-justify-content-space-between">
      <span class="bulma-has-text-grey bulma-is-size-7">
        <kbd class="bulma-tag">/</kbd> to open search &nbsp;
        <kbd class="bulma-tag">Esc</kbd> to close
      </span>
    </footer>
  </div>
</div>

  <main>
    
<section class="bulma-hero bulma-is-primary bulma-is-bold">
  <div class="bulma-hero-body bulma-container bulma-is-max-desktop">
    <p class="bulma-title">Error handling in Http4s with classy optics – Part 2</p>
    <p class="blog-post-byline bulma-subtitle">
      by
      
        Gabriel Volpe<span class="delimiter">,</span><span class="last-delimiter"> &</span>
      
      on November 28, 2018
    </p>
     
      <span class="bulma-tag">technical</span>
     
  </div>
</section>
<div class="bulma-section bulma-container bulma-is-max-desktop">
  <div class="blog-post bulma-content">
    <h1 id="error-handling-in-http4s-with-classy-optics-part-2" class="title">Error handling in Http4s with classy optics – Part 2</h1>
    <p>This is a continuation of my <a href="http4s-error-handling-mtl.html">previous blog post</a>. Make sure you have read that one before continuing here.</p>
    <p>I recently gave a 20 minutes talk on <code>classy optics</code> at the unconference of <a href="http://scale.bythebay.io/">Scale by the Bay</a> where I also talked about this error handling technique and on my way back home I was still thinking of different ways of doing this. So, after some exploratory work, I came up with a few different alternatives.</p>
    
    <h3 id="issues-with-first-approach" class="section"><a class="anchor-link" href="#issues-with-first-approach"><code class="fas fa-link fa-sm"></code></a>Issues with first approach</h3>
    <p>Something that made me cringe and that a few of my colleagues at work were not happy with was that the algebras had no association with the error type defined in <code>HttpErrorHandler[F, E]</code> so the type-safety was down to the programmer&#39;s discipline and in this case the compiler was not able to do much.</p>
    <p>When working with <code>EitherT[F, E, A]</code> or a bifunctor <code>IO[E, A]</code> we have a clear error type whereas by just relying on a single <code>F[A]</code> with a <code>MonadError[F, Throwable]</code> instance we lose this property. There are a few issues with the first though:</p>
    <ul>
      <li>It has a &quot;double error channel&quot;, meaning that can report errors via <code>Left</code> or via its effect type <code>IO</code>.</li>
      <li>As any other Monad Transformer in Scala, introduces a performance overhead due to the extra <code>flatMap</code> calls and extra allocations.</li>
      <li>Code becomes cumbersome as we need to lift effects and pure <code>Either</code> values into the transformer stack.</li>
    </ul>
    <p>The <code>IO[E, A]</code> model is naturally a better approach but I found out polymorphic code is more cumbersome than working with <code>F[A]</code>. Although this might change once <a href="https://github.com/typelevel/cats-effect/issues/321">Cats Effect 2.0</a> is out, it&#39;ll take a while until we get there.</p>
    
    <h4 id="errors-vs-failures" class="section"><a class="anchor-link" href="#errors-vs-failures"><code class="fas fa-link fa-sm"></code></a>Errors vs Failures</h4>
    <p>What I like about the <code>IO[E, A]</code> model is that we can distinguish between &quot;business errors&quot; and &quot;unexpected failures&quot; such as a database connection failure (learn more about <code>zio</code>&#39;s error model <a href="https://scalaz.github.io/scalaz-zio/">here</a>). Eg: when working on a REST API, most of the time we only care about mapping a few business errors into the appropriate http responses. The unexpected failures should be handled by someone else. In this case <code>http4s</code> will convert any failure into a response with code 500 (internal server error).</p>
    <p>And this is exactly what we want to achieve here. Writing polymorphic code using <code>cats-effect</code> while trying to keep it as simple as possible. Here&#39;s an encoding I would like to explore further:</p>
    
    <h3 id="error-channel" class="section"><a class="anchor-link" href="#error-channel"><code class="fas fa-link fa-sm"></code></a>Error Channel</h3>
    <p>In the previous blog post we defined the algebras as a single trait. In this case we are going to try a different encoding but first we need to introduce an <code>ErrorChannel[F, E]</code> typeclass where the error type is a subtype of <code>Throwable</code> to be compatible with the error type of the <code>cats-effect</code> typeclasses:</p>
    <pre><code class="nohighlight"><span class="keyword">trait</span><span> </span><span class="type-name">ErrorChannel</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>], </span><span class="type-name">E</span><span> &lt;: </span><span class="type-name">Throwable</span><span>] {
  </span><span class="keyword">def</span><span> </span><span class="declaration-name">raise</span><span>[</span><span class="type-name">A</span><span>](</span><span class="identifier">e</span><span>: </span><span class="type-name">E</span><span>): </span><span class="type-name">F</span><span>[</span><span class="type-name">A</span><span>]
}</span></code></pre>
    <p>An instance can be derived for any <code>ApplicativeError[F, Throwable]</code> so we don&#39;t need to write it manually for every error type.</p>
    <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="type-name">ApplicativeError</span><span>

</span><span class="keyword">object</span><span> </span><span class="type-name">ErrorChannel</span><span> {
  </span><span class="keyword">def</span><span> </span><span class="declaration-name">apply</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>], </span><span class="type-name">E</span><span> &lt;: </span><span class="type-name">Throwable</span><span>](</span><span class="keyword">implicit</span><span> </span><span class="identifier">ev</span><span>: </span><span class="type-name">ErrorChannel</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">E</span><span>]) = </span><span class="identifier">ev</span><span>

  </span><span class="keyword">implicit</span><span> </span><span class="keyword">def</span><span> </span><span class="declaration-name">instance</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>], </span><span class="type-name">E</span><span> &lt;: </span><span class="type-name">Throwable</span><span>](</span><span class="keyword">implicit</span><span> </span><span class="type-name">F</span><span>: </span><span class="type-name">ApplicativeError</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">Throwable</span><span>]): </span><span class="type-name">ErrorChannel</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">E</span><span>] =
    </span><span class="keyword">new</span><span> </span><span class="type-name">ErrorChannel</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">E</span><span>] {
      </span><span class="keyword">override</span><span> </span><span class="keyword">def</span><span> </span><span class="declaration-name">raise</span><span>[</span><span class="type-name">A</span><span>](</span><span class="identifier">e</span><span>: </span><span class="type-name">E</span><span>) = </span><span class="type-name">F</span><span>.</span><span class="identifier">raiseError</span><span>(</span><span class="identifier">e</span><span>)
    }

  </span><span class="keyword">object</span><span> </span><span class="identifier">syntax</span><span> {
    </span><span class="keyword">implicit</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">ErrorChannelOps</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]: </span><span class="type-name">ErrorChannel</span><span>[?[</span><span class="identifier">_</span><span>], </span><span class="type-name">E</span><span>], </span><span class="type-name">E</span><span> &lt;: </span><span class="type-name">Throwable</span><span>](</span><span class="identifier">e</span><span>: </span><span class="type-name">E</span><span>) {
      </span><span class="keyword">def</span><span> </span><span class="declaration-name">raise</span><span>[</span><span class="type-name">A</span><span>]: </span><span class="type-name">F</span><span>[</span><span class="type-name">A</span><span>] = </span><span class="type-name">ErrorChannel</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">E</span><span>].</span><span class="identifier">raise</span><span>[</span><span class="type-name">A</span><span>](</span><span class="identifier">e</span><span>)
    }
  }
}</span></code></pre>
    
    <h3 id="user-algebra" class="section"><a class="anchor-link" href="#user-algebra"><code class="fas fa-link fa-sm"></code></a>User Algebra</h3>
    <p>Our <code>UserAlg</code> will now be defined as an <code>abstract class</code> instead in order to be able to add typeclass constraint.</p>
    <pre><code class="nohighlight"><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">User</span><span>(</span><span class="identifier">username</span><span>: </span><span class="type-name">String</span><span>, </span><span class="identifier">age</span><span>: </span><span class="type-name">Int</span><span>)
</span><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">UserUpdateAge</span><span>(</span><span class="identifier">age</span><span>: </span><span class="type-name">Int</span><span>)

</span><span class="keyword">abstract</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">UserAlg</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]: </span><span class="type-name">ErrorChannel</span><span>[?[</span><span class="identifier">_</span><span>], </span><span class="type-name">E</span><span>], </span><span class="type-name">E</span><span> &lt;: </span><span class="type-name">Throwable</span><span>] {
  </span><span class="keyword">def</span><span> </span><span class="declaration-name">find</span><span>(</span><span class="identifier">username</span><span>: </span><span class="type-name">String</span><span>): </span><span class="type-name">F</span><span>[</span><span class="type-name">Option</span><span>[</span><span class="type-name">User</span><span>]]
  </span><span class="keyword">def</span><span> </span><span class="declaration-name">save</span><span>(</span><span class="identifier">user</span><span>: </span><span class="type-name">User</span><span>): </span><span class="type-name">F</span><span>[</span><span class="type-name">Unit</span><span>]
  </span><span class="keyword">def</span><span> </span><span class="declaration-name">updateAge</span><span>(</span><span class="identifier">username</span><span>: </span><span class="type-name">String</span><span>, </span><span class="identifier">age</span><span>: </span><span class="type-name">Int</span><span>): </span><span class="type-name">F</span><span>[</span><span class="type-name">Unit</span><span>]
}</span></code></pre>
    <p>And here&#39;s the ADT of the possible errors that may arise (notice the <code>extends Exception</code> part):</p>
    <pre><code class="nohighlight"><span class="keyword">sealed</span><span> </span><span class="keyword">trait</span><span> </span><span class="type-name">UserError</span><span> </span><span class="keyword">extends</span><span> </span><span class="type-name">Exception</span><span>
</span><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">UserAlreadyExists</span><span>(</span><span class="identifier">username</span><span>: </span><span class="type-name">String</span><span>) </span><span class="keyword">extends</span><span> </span><span class="type-name">UserError</span><span>
</span><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">UserNotFound</span><span>(</span><span class="identifier">username</span><span>: </span><span class="type-name">String</span><span>) </span><span class="keyword">extends</span><span> </span><span class="type-name">UserError</span><span>
</span><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">InvalidUserAge</span><span>(</span><span class="identifier">age</span><span>: </span><span class="type-name">Int</span><span>) </span><span class="keyword">extends</span><span> </span><span class="type-name">UserError</span></code></pre>
    <p>We want to make sure our ADT is a subtype of <code>Throwable</code> and indeed <code>Exception &lt;: Throwable</code>.</p>
    
    <h3 id="user-interpreter" class="section"><a class="anchor-link" href="#user-interpreter"><code class="fas fa-link fa-sm"></code></a>User Interpreter</h3>
    <p>Here&#39;s a similar <code>UserAlg</code> interpreter to the one presented in the previous post. Note that in a real-life project an interpreter will more likely connect to a database instead of using an in-memory representation based on <code>Ref</code>.</p>
    <p>The interesting part is that in order to construct a <code>UserAlg[F, UserError]</code> we now need an <code>ErrorChannel[F, UserError]</code> instance in scope. This will be the chosen strategy to report errors in the context of <code>F</code>.</p>
    <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.{ </span><span class="type-name">Concurrent</span><span>, </span><span class="type-name">Sync</span><span> }
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="identifier">concurrent</span><span>.</span><span class="type-name">Ref</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">syntax</span><span>.</span><span class="identifier">all</span><span>.</span><span class="identifier">_</span><span>

</span><span class="keyword">object</span><span> </span><span class="type-name">UserInterpreter</span><span> {

  </span><span class="keyword">def</span><span> </span><span class="declaration-name">mkUserAlg</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]: </span><span class="type-name">Sync</span><span>](</span><span class="keyword">implicit</span><span> </span><span class="identifier">error</span><span>: </span><span class="type-name">ErrorChannel</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">UserError</span><span>]): </span><span class="type-name">F</span><span>[</span><span class="type-name">UserAlg</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">UserError</span><span>]] =
    </span><span class="type-name">Ref</span><span>.</span><span class="identifier">of</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">Map</span><span>[</span><span class="type-name">String</span><span>, </span><span class="type-name">User</span><span>]](</span><span class="type-name">Map</span><span>.</span><span class="identifier">empty</span><span>).</span><span class="identifier">map</span><span> { </span><span class="identifier">state</span><span> =&gt;
      </span><span class="keyword">new</span><span> </span><span class="type-name">UserAlg</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">UserError</span><span>] {
        </span><span class="keyword">private</span><span> </span><span class="keyword">def</span><span> </span><span class="declaration-name">validateAge</span><span>(</span><span class="identifier">age</span><span>: </span><span class="type-name">Int</span><span>): </span><span class="type-name">F</span><span>[</span><span class="type-name">Unit</span><span>] =
          </span><span class="keyword">if</span><span> (</span><span class="identifier">age</span><span> &lt;= </span><span class="number-literal">0</span><span>) </span><span class="identifier">error</span><span>.</span><span class="identifier">raise</span><span>(</span><span class="type-name">InvalidUserAge</span><span>(</span><span class="identifier">age</span><span>)) </span><span class="keyword">else</span><span> ().</span><span class="identifier">pure</span><span>[</span><span class="type-name">F</span><span>]

        </span><span class="keyword">override</span><span> </span><span class="keyword">def</span><span> </span><span class="declaration-name">find</span><span>(</span><span class="identifier">username</span><span>: </span><span class="type-name">String</span><span>): </span><span class="type-name">F</span><span>[</span><span class="type-name">Option</span><span>[</span><span class="type-name">User</span><span>]] =
          </span><span class="identifier">state</span><span>.</span><span class="identifier">get</span><span>.</span><span class="identifier">map</span><span>(</span><span class="identifier">_</span><span>.</span><span class="identifier">get</span><span>(</span><span class="identifier">username</span><span>))

        </span><span class="keyword">override</span><span> </span><span class="keyword">def</span><span> </span><span class="declaration-name">save</span><span>(</span><span class="identifier">user</span><span>: </span><span class="type-name">User</span><span>): </span><span class="type-name">F</span><span>[</span><span class="type-name">Unit</span><span>] =
          </span><span class="identifier">validateAge</span><span>(</span><span class="identifier">user</span><span>.</span><span class="identifier">age</span><span>) *&gt;
            </span><span class="identifier">find</span><span>(</span><span class="identifier">user</span><span>.</span><span class="identifier">username</span><span>).</span><span class="identifier">flatMap</span><span> {
              </span><span class="keyword">case</span><span> </span><span class="type-name">Some</span><span>(</span><span class="identifier">_</span><span>) =&gt;
                </span><span class="identifier">error</span><span>.</span><span class="identifier">raise</span><span>(</span><span class="type-name">UserAlreadyExists</span><span>(</span><span class="identifier">user</span><span>.</span><span class="identifier">username</span><span>))
</span><span class="comment">//                error.raise(new Exception(&quot;asd&quot;)) // Does not compile
//                Sync[F].raiseError(new Exception(&quot;&quot;)) // Should be considered an unrecoverable failure
</span><span>              </span><span class="keyword">case</span><span> </span><span class="type-name">None</span><span> =&gt;
                </span><span class="identifier">state</span><span>.</span><span class="identifier">update</span><span>(</span><span class="identifier">_</span><span>.</span><span class="identifier">updated</span><span>(</span><span class="identifier">user</span><span>.</span><span class="identifier">username</span><span>, </span><span class="identifier">user</span><span>))
            }

        </span><span class="keyword">override</span><span> </span><span class="keyword">def</span><span> </span><span class="declaration-name">updateAge</span><span>(</span><span class="identifier">username</span><span>: </span><span class="type-name">String</span><span>, </span><span class="identifier">age</span><span>: </span><span class="type-name">Int</span><span>): </span><span class="type-name">F</span><span>[</span><span class="type-name">Unit</span><span>] =
          </span><span class="identifier">validateAge</span><span>(</span><span class="identifier">age</span><span>) *&gt;
            </span><span class="identifier">find</span><span>(</span><span class="identifier">username</span><span>).</span><span class="identifier">flatMap</span><span> {
              </span><span class="keyword">case</span><span> </span><span class="type-name">Some</span><span>(</span><span class="identifier">user</span><span>) =&gt;
                </span><span class="identifier">state</span><span>.</span><span class="identifier">update</span><span>(</span><span class="identifier">_</span><span>.</span><span class="identifier">updated</span><span>(</span><span class="identifier">username</span><span>, </span><span class="identifier">user</span><span>.</span><span class="identifier">copy</span><span>(</span><span class="identifier">age</span><span> = </span><span class="identifier">age</span><span>)))
              </span><span class="keyword">case</span><span> </span><span class="type-name">None</span><span> =&gt;
                </span><span class="identifier">error</span><span>.</span><span class="identifier">raise</span><span>(</span><span class="type-name">UserNotFound</span><span>(</span><span class="identifier">username</span><span>))
            }
      }
    }

}</span></code></pre>
    <p>Notice that we could still call <code>Sync[F].raiseError(new Exception(&quot;boom&quot;))</code> and it will still compile. However, if we choose to use <code>ErrorChannel</code> to signal business errors we will have the compiler on our side and it&#39;ll warn us when we try to raise an error that is not part of the ADT we have declared. So signaling error in a different way should just be considered unrecoverable. These are the same semantics you get when working with <code>EitherT[IO, Throwable, ?]</code> as shown in the comparison table at the beginning.</p>
    
    <h3 id="http-error-handler" class="section"><a class="anchor-link" href="#http-error-handler"><code class="fas fa-link fa-sm"></code></a>Http Error Handler</h3>
    <p>Here&#39;s the same <code>HttpErrorHandler</code> defined in the previous blog post:</p>
    <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.{ </span><span class="type-name">ApplicativeError</span><span>, </span><span class="type-name">MonadError</span><span> }
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">data</span><span>.{ </span><span class="type-name">Kleisli</span><span>, </span><span class="type-name">OptionT</span><span> }
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">_</span><span>

</span><span class="keyword">trait</span><span> </span><span class="type-name">HttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>], </span><span class="type-name">E</span><span> &lt;: </span><span class="type-name">Throwable</span><span>] {
  </span><span class="keyword">def</span><span> </span><span class="declaration-name">handle</span><span>(</span><span class="identifier">routes</span><span>: </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>]): </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>]
}

</span><span class="keyword">object</span><span> </span><span class="type-name">RoutesHttpErrorHandler</span><span> {
  </span><span class="keyword">def</span><span> </span><span class="declaration-name">apply</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]: </span><span class="type-name">ApplicativeError</span><span>[?[</span><span class="identifier">_</span><span>], </span><span class="type-name">E</span><span>], </span><span class="type-name">E</span><span> &lt;: </span><span class="type-name">Throwable</span><span>](
      </span><span class="identifier">routes</span><span>: </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>]
  )(</span><span class="identifier">handler</span><span>: </span><span class="type-name">E</span><span> =&gt; </span><span class="type-name">F</span><span>[</span><span class="type-name">Response</span><span>[</span><span class="type-name">F</span><span>]]): </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>] =
    </span><span class="type-name">Kleisli</span><span> { </span><span class="identifier">req</span><span> =&gt;
      </span><span class="type-name">OptionT</span><span> {
        </span><span class="identifier">routes</span><span>.</span><span class="identifier">run</span><span>(</span><span class="identifier">req</span><span>).</span><span class="identifier">value</span><span>.</span><span class="identifier">handleErrorWith</span><span>(</span><span class="identifier">e</span><span> =&gt; </span><span class="identifier">handler</span><span>(</span><span class="identifier">e</span><span>).</span><span class="identifier">map</span><span>(</span><span class="type-name">Option</span><span>(</span><span class="identifier">_</span><span>)))
      }
    }
}

</span><span class="keyword">object</span><span> </span><span class="type-name">HttpErrorHandler</span><span> {
  </span><span class="keyword">def</span><span> </span><span class="declaration-name">apply</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>], </span><span class="type-name">E</span><span> &lt;: </span><span class="type-name">Throwable</span><span>](</span><span class="keyword">implicit</span><span> </span><span class="identifier">ev</span><span>: </span><span class="type-name">HttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">E</span><span>]) = </span><span class="identifier">ev</span><span>

  </span><span class="keyword">def</span><span> </span><span class="declaration-name">mkInstance</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]: </span><span class="type-name">ApplicativeError</span><span>[?[</span><span class="identifier">_</span><span>], </span><span class="type-name">E</span><span>], </span><span class="type-name">E</span><span> &lt;: </span><span class="type-name">Throwable</span><span>](
      </span><span class="identifier">handler</span><span>: </span><span class="type-name">E</span><span> =&gt; </span><span class="type-name">F</span><span>[</span><span class="type-name">Response</span><span>[</span><span class="type-name">F</span><span>]]
  ): </span><span class="type-name">HttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">E</span><span>] =
    (</span><span class="identifier">routes</span><span>: </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>]) =&gt; </span><span class="type-name">RoutesHttpErrorHandler</span><span>(</span><span class="identifier">routes</span><span>)(</span><span class="identifier">handler</span><span>)
}</span></code></pre>
    
    <h3 id="http-routes-with-error-handling" class="section"><a class="anchor-link" href="#http-routes-with-error-handling"><code class="fas fa-link fa-sm"></code></a>Http Routes with error handling</h3>
    <p>Now let&#39;s look at the new implementation of <code>UserRoutes</code> using the error-type algebra:</p>
    <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">effect</span><span>.</span><span class="type-name">Sync</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">cats</span><span>.</span><span class="identifier">syntax</span><span>.</span><span class="identifier">all</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">io</span><span>.</span><span class="identifier">circe</span><span>.</span><span class="identifier">generic</span><span>.</span><span class="identifier">auto</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">io</span><span>.</span><span class="identifier">circe</span><span>.</span><span class="identifier">syntax</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">circe</span><span>.</span><span class="type-name">CirceEntityDecoder</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">circe</span><span>.</span><span class="identifier">_</span><span>
</span><span class="keyword">import</span><span> </span><span class="identifier">org</span><span>.</span><span class="identifier">http4s</span><span>.</span><span class="identifier">dsl</span><span>.</span><span class="type-name">Http4sDsl</span><span>

</span><span class="keyword">class</span><span> </span><span class="type-name">PreUserRoutesMTL</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]: </span><span class="type-name">Sync</span><span>](</span><span class="identifier">users</span><span>: </span><span class="type-name">UserAlg</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">UserError</span><span>]) </span><span class="keyword">extends</span><span> </span><span class="type-name">Http4sDsl</span><span>[</span><span class="type-name">F</span><span>] {

  </span><span class="keyword">private</span><span> </span><span class="keyword">val</span><span> </span><span class="identifier">httpRoutes</span><span>: </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>] = </span><span class="type-name">HttpRoutes</span><span>.</span><span class="identifier">of</span><span>[</span><span class="type-name">F</span><span>] {

    </span><span class="keyword">case</span><span> </span><span class="type-name">GET</span><span> -&gt; </span><span class="type-name">Root</span><span> / </span><span class="string-literal">&quot;users&quot;</span><span> / </span><span class="identifier">username</span><span> =&gt;
      </span><span class="identifier">users</span><span>.</span><span class="identifier">find</span><span>(</span><span class="identifier">username</span><span>).</span><span class="identifier">flatMap</span><span> {
        </span><span class="keyword">case</span><span> </span><span class="type-name">Some</span><span>(</span><span class="identifier">user</span><span>) =&gt; </span><span class="type-name">Ok</span><span>(</span><span class="identifier">user</span><span>.</span><span class="identifier">asJson</span><span>)
        </span><span class="keyword">case</span><span> </span><span class="type-name">None</span><span>       =&gt; </span><span class="type-name">NotFound</span><span>(</span><span class="identifier">username</span><span>.</span><span class="identifier">asJson</span><span>)
      }

    </span><span class="keyword">case</span><span> </span><span class="identifier">req</span><span> @ </span><span class="type-name">POST</span><span> -&gt; </span><span class="type-name">Root</span><span> / </span><span class="string-literal">&quot;users&quot;</span><span> =&gt;
      </span><span class="identifier">req</span><span>.</span><span class="identifier">as</span><span>[</span><span class="type-name">User</span><span>].</span><span class="identifier">flatMap</span><span> { </span><span class="identifier">user</span><span> =&gt;
        </span><span class="identifier">users</span><span>.</span><span class="identifier">save</span><span>(</span><span class="identifier">user</span><span>) *&gt; </span><span class="type-name">Created</span><span>(</span><span class="identifier">user</span><span>.</span><span class="identifier">username</span><span>.</span><span class="identifier">asJson</span><span>)
      }

    </span><span class="keyword">case</span><span> </span><span class="identifier">req</span><span> @ </span><span class="type-name">PUT</span><span> -&gt; </span><span class="type-name">Root</span><span> / </span><span class="string-literal">&quot;users&quot;</span><span> / </span><span class="identifier">username</span><span> =&gt;
      </span><span class="identifier">req</span><span>.</span><span class="identifier">as</span><span>[</span><span class="type-name">UserUpdateAge</span><span>].</span><span class="identifier">flatMap</span><span> { </span><span class="identifier">userUpdate</span><span> =&gt;
        </span><span class="identifier">users</span><span>.</span><span class="identifier">updateAge</span><span>(</span><span class="identifier">username</span><span>, </span><span class="identifier">userUpdate</span><span>.</span><span class="identifier">age</span><span>) *&gt; </span><span class="type-name">Created</span><span>(</span><span class="identifier">username</span><span>.</span><span class="identifier">asJson</span><span>)
      }
  }

  </span><span class="keyword">def</span><span> </span><span class="declaration-name">routes</span><span>(</span><span class="keyword">implicit</span><span> </span><span class="type-name">H</span><span>: </span><span class="type-name">HttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">UserError</span><span>]): </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>] =
    </span><span class="type-name">H</span><span>.</span><span class="identifier">handle</span><span>(</span><span class="identifier">httpRoutes</span><span>)

}</span></code></pre>
    <p>Notice that in contrast to the example shown in the previous blog post there is now a relationship between <code>UserAlg</code> and <code>HttpErrorHandler</code>: the error type is the same. However, this is not enforced by the compiler. <em>Can we be more strict about it?</em></p>
    <p>We could define a generic <code>Routes[F, E]</code>:</p>
    <pre><code class="nohighlight"><span class="keyword">abstract</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">Routes</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>], </span><span class="type-name">E</span><span> &lt;: </span><span class="type-name">Throwable</span><span>](</span><span class="keyword">implicit</span><span> </span><span class="type-name">H</span><span>: </span><span class="type-name">HttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">E</span><span>]) </span><span class="keyword">extends</span><span> </span><span class="type-name">Http4sDsl</span><span>[</span><span class="type-name">F</span><span>] {
  </span><span class="keyword">protected</span><span> </span><span class="keyword">def</span><span> </span><span class="declaration-name">httpRoutes</span><span>: </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>]
  </span><span class="keyword">val</span><span> </span><span class="identifier">routes</span><span>: </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>] = </span><span class="type-name">H</span><span>.</span><span class="identifier">handle</span><span>(</span><span class="identifier">httpRoutes</span><span>)
}</span></code></pre>
    <p>But we&#39;ll also need something else to connect the error types of the algebra and the http error handler:</p>
    <pre><code class="nohighlight"><span class="keyword">abstract</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">UserRoutes</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]: </span><span class="type-name">HttpErrorHandler</span><span>[?[</span><span class="identifier">_</span><span>], </span><span class="type-name">E</span><span>], </span><span class="type-name">E</span><span> &lt;: </span><span class="type-name">Throwable</span><span>](
    </span><span class="identifier">users</span><span>: </span><span class="type-name">UserAlg</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">E</span><span>]
) </span><span class="keyword">extends</span><span> </span><span class="type-name">Routes</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">E</span><span>]</span></code></pre>
    <p>That&#39;s it! We are now enforcing this relationship at compile time. Let&#39;s see how the <code>HttpRoutes</code> looks like:</p>
    <pre><code class="nohighlight"><span class="keyword">class</span><span> </span><span class="type-name">UserRoutesAlt</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]: </span><span class="type-name">HttpErrorHandler</span><span>[?[</span><span class="identifier">_</span><span>], </span><span class="type-name">UserError</span><span>]: </span><span class="type-name">Sync</span><span>](
    </span><span class="identifier">users</span><span>: </span><span class="type-name">UserAlg</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">UserError</span><span>]
) </span><span class="keyword">extends</span><span> </span><span class="type-name">UserRoutes</span><span>(</span><span class="identifier">users</span><span>) {

  </span><span class="keyword">protected</span><span> </span><span class="keyword">val</span><span> </span><span class="identifier">httpRoutes</span><span>: </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>] = </span><span class="type-name">HttpRoutes</span><span>.</span><span class="identifier">of</span><span>[</span><span class="type-name">F</span><span>] {

    </span><span class="keyword">case</span><span> </span><span class="type-name">GET</span><span> -&gt; </span><span class="type-name">Root</span><span> / </span><span class="string-literal">&quot;users&quot;</span><span> / </span><span class="identifier">username</span><span> =&gt;
      </span><span class="identifier">users</span><span>.</span><span class="identifier">find</span><span>(</span><span class="identifier">username</span><span>).</span><span class="identifier">flatMap</span><span> {
        </span><span class="keyword">case</span><span> </span><span class="type-name">Some</span><span>(</span><span class="identifier">user</span><span>) =&gt; </span><span class="type-name">Ok</span><span>(</span><span class="identifier">user</span><span>.</span><span class="identifier">asJson</span><span>)
        </span><span class="keyword">case</span><span> </span><span class="type-name">None</span><span>       =&gt; </span><span class="type-name">NotFound</span><span>(</span><span class="identifier">username</span><span>.</span><span class="identifier">asJson</span><span>)
      }

    </span><span class="keyword">case</span><span> </span><span class="identifier">req</span><span> @ </span><span class="type-name">POST</span><span> -&gt; </span><span class="type-name">Root</span><span> / </span><span class="string-literal">&quot;users&quot;</span><span> =&gt;
      </span><span class="identifier">req</span><span>
        .</span><span class="identifier">as</span><span>[</span><span class="type-name">User</span><span>]
        .</span><span class="identifier">flatMap</span><span> { </span><span class="identifier">user</span><span> =&gt;
          </span><span class="identifier">users</span><span>.</span><span class="identifier">save</span><span>(</span><span class="identifier">user</span><span>) *&gt; </span><span class="type-name">Created</span><span>(</span><span class="identifier">user</span><span>.</span><span class="identifier">username</span><span>.</span><span class="identifier">asJson</span><span>)
        }

    </span><span class="keyword">case</span><span> </span><span class="identifier">req</span><span> @ </span><span class="type-name">PUT</span><span> -&gt; </span><span class="type-name">Root</span><span> / </span><span class="string-literal">&quot;users&quot;</span><span> / </span><span class="identifier">username</span><span> =&gt;
      </span><span class="identifier">req</span><span>
        .</span><span class="identifier">as</span><span>[</span><span class="type-name">UserUpdateAge</span><span>]
        .</span><span class="identifier">flatMap</span><span> { </span><span class="identifier">userUpdate</span><span> =&gt;
          </span><span class="identifier">users</span><span>.</span><span class="identifier">updateAge</span><span>(</span><span class="identifier">username</span><span>, </span><span class="identifier">userUpdate</span><span>.</span><span class="identifier">age</span><span>) *&gt; </span><span class="type-name">Ok</span><span>(</span><span class="identifier">username</span><span>.</span><span class="identifier">asJson</span><span>)
        }
  }

}</span></code></pre>
    <p>Neat! Right? If we try to change the error type of <code>UserAlg</code> it wouldn&#39;t compile!</p>
    
    <h3 id="more-than-one-algebra-per-http-route" class="section"><a class="anchor-link" href="#more-than-one-algebra-per-http-route"><code class="fas fa-link fa-sm"></code></a>More than one algebra per Http Route</h3>
    <p>In most of my programs I tend to specify an <code>HttpRoute</code> per algebra. But what if we wanted to just define a single <code>HttpRoute</code> that uses multiple algebras? There are a couple of options.</p>
    <p>Let&#39;s first define a new ADT of errors and a new algebra to illustrate the problem:</p>
    
    <h4 id="catalog-error" class="section"><a class="anchor-link" href="#catalog-error"><code class="fas fa-link fa-sm"></code></a>Catalog Error</h4>
    <pre><code class="nohighlight"><span class="keyword">sealed</span><span> </span><span class="keyword">trait</span><span> </span><span class="type-name">CatalogError</span><span> </span><span class="keyword">extends</span><span> </span><span class="type-name">Exception</span><span>
</span><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">ItemAlreadyExists</span><span>(</span><span class="identifier">item</span><span>: </span><span class="type-name">String</span><span>) </span><span class="keyword">extends</span><span> </span><span class="type-name">CatalogError</span><span>
</span><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">CatalogNotFound</span><span>(</span><span class="identifier">id</span><span>: </span><span class="type-name">Long</span><span>) </span><span class="keyword">extends</span><span> </span><span class="type-name">CatalogError</span></code></pre>
    
    <h4 id="catalogalg" class="section"><a class="anchor-link" href="#catalogalg"><code class="fas fa-link fa-sm"></code></a>CatalogAlg</h4>
    <pre><code class="nohighlight"><span class="keyword">case</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">Item</span><span>(</span><span class="identifier">name</span><span>: </span><span class="type-name">String</span><span>) </span><span class="keyword">extends</span><span> </span><span class="type-name">AnyVal</span><span>

</span><span class="keyword">abstract</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">CatalogAlg</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]: </span><span class="type-name">ErrorChannel</span><span>[?[</span><span class="identifier">_</span><span>], </span><span class="type-name">E</span><span>], </span><span class="type-name">E</span><span> &lt;: </span><span class="type-name">Throwable</span><span>] {
  </span><span class="keyword">def</span><span> </span><span class="declaration-name">find</span><span>(</span><span class="identifier">id</span><span>: </span><span class="type-name">Long</span><span>): </span><span class="type-name">F</span><span>[</span><span class="type-name">List</span><span>[</span><span class="type-name">Item</span><span>]]
  </span><span class="keyword">def</span><span> </span><span class="declaration-name">save</span><span>(</span><span class="identifier">id</span><span>: </span><span class="type-name">Long</span><span>, </span><span class="identifier">item</span><span>: </span><span class="type-name">Item</span><span>): </span><span class="type-name">F</span><span>[</span><span class="type-name">Unit</span><span>]
}</span></code></pre>
    
    <h4 id="httproutes-with-multiple-algebras" class="section"><a class="anchor-link" href="#httproutes-with-multiple-algebras"><code class="fas fa-link fa-sm"></code></a>HttpRoutes with multiple algebras</h4>
    <p>Here we have an <code>HttpRoutes</code> that makes use of two algebras with different error types:</p>
    <pre><code class="nohighlight"><span class="keyword">class</span><span> </span><span class="type-name">UserRoutesMTL</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]: </span><span class="type-name">Sync</span><span>](
    </span><span class="identifier">users</span><span>: </span><span class="type-name">UserAlg</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">UserError</span><span>],
    </span><span class="identifier">catalog</span><span>: </span><span class="type-name">CatalogAlg</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">CatalogError</span><span>]
) </span><span class="keyword">extends</span><span> </span><span class="type-name">Http4sDsl</span><span>[</span><span class="type-name">F</span><span>] {

  </span><span class="keyword">private</span><span> </span><span class="keyword">val</span><span> </span><span class="identifier">httpRoutes</span><span>: </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>] = ???

  </span><span class="keyword">def</span><span> </span><span class="declaration-name">routes</span><span>(
    </span><span class="keyword">implicit</span><span> </span><span class="type-name">H1</span><span>: </span><span class="type-name">HttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">UserError</span><span>],
             </span><span class="type-name">H2</span><span>: </span><span class="type-name">HttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">CatalogError</span><span>]
  ): </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>] =
    </span><span class="type-name">H2</span><span>.</span><span class="identifier">handle</span><span>(</span><span class="type-name">H1</span><span>.</span><span class="identifier">handle</span><span>(</span><span class="identifier">httpRoutes</span><span>))

}</span></code></pre>
    <p>It works! But it&#39;s not as elegant as we would like it to be and if we add more algebras this would quicky get out of control.</p>
    <p><em>Can we generalize this pattern?</em></p>
    
    <h3 id="shapeless-coproduct" class="section"><a class="anchor-link" href="#shapeless-coproduct"><code class="fas fa-link fa-sm"></code></a>Shapeless Coproduct</h3>
    <p>We can define our error type as a coproduct of different errors, in our case <code>UserError</code> and <code>CatalogError</code>. For example:</p>
    <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">shapeless</span><span>.</span><span class="identifier">_</span><span>

</span><span class="keyword">def</span><span> </span><span class="declaration-name">routes</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]](</span><span class="keyword">implicit</span><span> </span><span class="type-name">H</span><span>: </span><span class="type-name">HttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">UserError</span><span> :+: </span><span class="type-name">CatalogError</span><span> :+: </span><span class="type-name">CNil</span><span>]) = ???</span></code></pre>
    <p>However, this doesn&#39;t compile because the error type is no longer a subtype of <code>Throwable</code>. It is now a <code>Coproduct</code>.</p>
    <p>But we might be able to derive an instance for a coproduct of errors if we have an instance of <code>HttpErrorHandler[F, E]</code> for each error type. Let&#39;s give it a try! We need to define a new typeclass <code>CoHttpErrorHandler</code>:</p>
    <pre><code class="nohighlight"><span class="keyword">import</span><span> </span><span class="identifier">shapeless</span><span>.</span><span class="identifier">_</span><span>

</span><span class="keyword">trait</span><span> </span><span class="type-name">CoHttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>], </span><span class="type-name">Err</span><span> &lt;: </span><span class="type-name">Coproduct</span><span>] {
  </span><span class="keyword">def</span><span> </span><span class="declaration-name">handle</span><span>(</span><span class="identifier">routes</span><span>: </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>]): </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>]
}

</span><span class="keyword">object</span><span> </span><span class="type-name">CoHttpErrorHandler</span><span> {
  </span><span class="keyword">def</span><span> </span><span class="declaration-name">apply</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>], </span><span class="type-name">Err</span><span> &lt;: </span><span class="type-name">Coproduct</span><span>](</span><span class="keyword">implicit</span><span> </span><span class="identifier">ev</span><span>: </span><span class="type-name">CoHttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">Err</span><span>]) = </span><span class="identifier">ev</span><span>

  </span><span class="keyword">implicit</span><span> </span><span class="keyword">def</span><span> </span><span class="declaration-name">cNilInstance</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]]: </span><span class="type-name">CoHttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">CNil</span><span>] =
    (</span><span class="identifier">routes</span><span>: </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>]) =&gt; </span><span class="identifier">routes</span><span>

  </span><span class="keyword">implicit</span><span> </span><span class="keyword">def</span><span> </span><span class="declaration-name">consInstance</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>], </span><span class="type-name">E</span><span> &lt;: </span><span class="type-name">Throwable</span><span>, </span><span class="type-name">T</span><span> &lt;: </span><span class="type-name">Coproduct</span><span>](
      </span><span class="keyword">implicit</span><span> </span><span class="type-name">H</span><span>: </span><span class="type-name">HttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">E</span><span>],
      </span><span class="type-name">CH</span><span>: </span><span class="type-name">CoHttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">T</span><span>]
  ): </span><span class="type-name">CoHttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">E</span><span> :+: </span><span class="type-name">T</span><span>] =
    (</span><span class="identifier">routes</span><span>: </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>]) =&gt; </span><span class="type-name">CH</span><span>.</span><span class="identifier">handle</span><span>(</span><span class="type-name">H</span><span>.</span><span class="identifier">handle</span><span>(</span><span class="identifier">routes</span><span>))
}</span></code></pre>
    <p>Voilà! We introduced a <code>CoHttpErrorHandler</code> where the error type is a coproduct and the instance can only be derived if each type is a subtype of <code>Throwable</code> making it impossible to define an invalid coproduct. So it compiles! But how do we use it?</p>
    
    <h3 id="httproutes-for-a-coproduct-of-errors" class="section"><a class="anchor-link" href="#httproutes-for-a-coproduct-of-errors"><code class="fas fa-link fa-sm"></code></a>HttpRoutes for a coproduct of errors</h3>
    <pre><code class="nohighlight"><span class="keyword">class</span><span> </span><span class="type-name">CoUserRoutesMTL</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]: </span><span class="type-name">Sync</span><span>](
    </span><span class="identifier">users</span><span>: </span><span class="type-name">UserAlg</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">UserError</span><span>],
    </span><span class="identifier">catalog</span><span>: </span><span class="type-name">CatalogAlg</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">CatalogError</span><span>]
) </span><span class="keyword">extends</span><span> </span><span class="type-name">Http4sDsl</span><span>[</span><span class="type-name">F</span><span>] {

  </span><span class="keyword">private</span><span> </span><span class="keyword">val</span><span> </span><span class="identifier">httpRoutes</span><span>: </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>] = ???

  </span><span class="keyword">def</span><span> </span><span class="declaration-name">routes</span><span>(</span><span class="keyword">implicit</span><span> </span><span class="type-name">CH</span><span>: </span><span class="type-name">CoHttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">UserError</span><span> :+: </span><span class="type-name">CatalogError</span><span> :+: </span><span class="type-name">CNil</span><span>]): </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>] =
    </span><span class="type-name">CH</span><span>.</span><span class="identifier">handle</span><span>(</span><span class="identifier">httpRoutes</span><span>)

}</span></code></pre>
    <p>Yay!!! Now this is more elegant and generic so we can re-use the same pattern in different routes. But now again we have lost the relationship between the error types of the algebras and the error type of <code>CoHttpErrorHandler</code>. So maybe we could do something similar to what we have done previously?</p>
    <p>It&#39;s possible but in the case of coproducts we need to introduce some boilerplate...</p>
    
    <h4 id="coroutes" class="section"><a class="anchor-link" href="#coroutes"><code class="fas fa-link fa-sm"></code></a>CoRoutes</h4>
    <pre><code class="nohighlight"><span class="keyword">abstract</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">CoRoutes</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>], </span><span class="type-name">E</span><span> &lt;: </span><span class="type-name">Coproduct</span><span>](</span><span class="keyword">implicit</span><span> </span><span class="type-name">CH</span><span>: </span><span class="type-name">CoHttpErrorHandler</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">E</span><span>]) </span><span class="keyword">extends</span><span> </span><span class="type-name">Http4sDsl</span><span>[</span><span class="type-name">F</span><span>] {
  </span><span class="keyword">protected</span><span> </span><span class="keyword">def</span><span> </span><span class="declaration-name">httpRoutes</span><span>: </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>]
  </span><span class="keyword">val</span><span> </span><span class="identifier">routes</span><span>: </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>] = </span><span class="type-name">CH</span><span>.</span><span class="identifier">handle</span><span>(</span><span class="identifier">httpRoutes</span><span>)
}</span></code></pre>
    <p>This one is pretty basic and similar to <code>Routes</code> defined before.</p>
    
    <h4 id="couserroutes" class="section"><a class="anchor-link" href="#couserroutes"><code class="fas fa-link fa-sm"></code></a>CoUserRoutes</h4>
    <pre><code class="nohighlight"><span class="keyword">abstract</span><span> </span><span class="keyword">class</span><span> </span><span class="type-name">CoUserRoutes</span><span>[
    </span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]: </span><span class="type-name">CoHttpErrorHandler</span><span>[?[</span><span class="identifier">_</span><span>], </span><span class="type-name">E</span><span>],
    </span><span class="type-name">A</span><span> &lt;: </span><span class="type-name">Throwable</span><span>,
    </span><span class="type-name">B</span><span> &lt;: </span><span class="type-name">Throwable</span><span>,
    </span><span class="type-name">E</span><span> &lt;: </span><span class="type-name">Coproduct</span><span>: =:=[?, </span><span class="type-name">A</span><span> :+: </span><span class="type-name">B</span><span> :+: </span><span class="type-name">CNil</span><span>]
](
    </span><span class="identifier">users</span><span>: </span><span class="type-name">UserAlg</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">A</span><span>],
    </span><span class="identifier">catalog</span><span>: </span><span class="type-name">CatalogAlg</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">B</span><span>]
) </span><span class="keyword">extends</span><span> </span><span class="type-name">CoRoutes</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">E</span><span>]

</span><span class="keyword">type</span><span> </span><span class="type-name">CustomError</span><span> = </span><span class="type-name">UserError</span><span> :+: </span><span class="type-name">CatalogError</span><span> :+: </span><span class="type-name">CNil</span></code></pre>
    <p>Here we have a couple of constraints:</p>
    <ul>
      <li><code>F[_]</code> needs to have an instance of <code>CoHttpErrorHandler[F, E]</code>.</li>
      <li><code>A</code> and <code>B</code> are the error types of the two algebras.</li>
      <li><code>E</code> needs to be a <code>Coproduct</code> of type <code>A :+: B :+: CNil</code>.</li>
    </ul>
    
    <h4 id="httproutes-with-multiple-algebras-strict-version" class="section"><a class="anchor-link" href="#httproutes-with-multiple-algebras-strict-version"><code class="fas fa-link fa-sm"></code></a>HttpRoutes with multiple algebras - Strict version</h4>
    <pre><code class="nohighlight"><span class="keyword">class</span><span> </span><span class="type-name">CoUserRoutesMTL</span><span>[</span><span class="type-name">F</span><span>[</span><span class="identifier">_</span><span>]: </span><span class="type-name">CoHttpErrorHandler</span><span>[?[</span><span class="identifier">_</span><span>], </span><span class="type-name">CustomError</span><span>]: </span><span class="type-name">Sync</span><span>](
    </span><span class="identifier">users</span><span>: </span><span class="type-name">UserAlg</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">UserError</span><span>],
    </span><span class="identifier">catalog</span><span>: </span><span class="type-name">CatalogAlg</span><span>[</span><span class="type-name">F</span><span>, </span><span class="type-name">CatalogError</span><span>]
) </span><span class="keyword">extends</span><span> </span><span class="type-name">CoUserRoutes</span><span>(</span><span class="identifier">users</span><span>, </span><span class="identifier">catalog</span><span>) {

  </span><span class="keyword">protected</span><span> </span><span class="keyword">val</span><span> </span><span class="identifier">httpRoutes</span><span>: </span><span class="type-name">HttpRoutes</span><span>[</span><span class="type-name">F</span><span>] = ???

}</span></code></pre>
    <p>Now we are saying that the error type of our <code>CoHttpErrorHandler</code> is a coproduct of each error type of the algebras. And we wouldn&#39;t be able to change the error type of any of them without getting a compiler error.</p>
    
    <h3 id="source-code" class="section"><a class="anchor-link" href="#source-code"><code class="fas fa-link fa-sm"></code></a>Source code</h3>
    <p>You can see all the compiling examples <a href="https://github.com/gvolpe/classy-optics">here</a>. Make sure you check out all the different branches.</p>
    
    <h3 id="conclusion" class="section"><a class="anchor-link" href="#conclusion"><code class="fas fa-link fa-sm"></code></a>Conclusion</h3>
    <p>The last approach is probably too much but we have demonstrated that it&#39;s possible to push the boundaries to make our application very type-safe. However, we also need to consider the trade-offs of writing more boilerplate.</p>
    <p>Personally, I settle for the previous approach where the error type of the algebra matches the error type of the <code>HttpErrorHandler</code> even if it requires a bit more of discipline. The choice is yours! Just make sure you understand the trade-offs of every mechanism.</p>
    <p>I hope you have enjoyed this post and please do let me know if you have other ideas to keep broadening my understanding!</p>
  </div>
</div>
<div class="bulma-section bulma-container bulma-is-max-desktop">
  <div class="bulma-columns">
    
    <div class="bulma-column">
      <article class="bulma-media">
        
        <figure class="bulma-media-left">
          <p class="bulma-image bulma-is-64x64">
            <img class="bulma-is-rounded" src="https://github.com/gvolpe.png" />
          </p>
        </figure>
        
        <div class="bulma-media-content">
          <div class="bulma-content">
            <p>
              <strong>Gabriel Volpe</strong>
              
            </p>
          </div>
          <nav class="bulma-level">
            <div class="bulma-level-left bulma-is-flex-direction-row">
              
              <a class="bulma-level-item" href="http://github.com/gvolpe">
                <span class="bulma-icon bulma-is-small"><i class="fab fa-github"></i></span>
              </a>
              
              
              
              
            </div>
          </nav>
        </div>
      </article>
    </div>
    
  </div>
</div>


  </main>
  <footer class="bulma-footer">
  <div class="bulma-columns">
    <div class="bulma-column">
      Copyright <i class="fab fa-creative-commons"></i> Typelevel Foundation and contributors.
    </div>
    <div class="bulma-column">
      <ul>
        <li><a href="../projects/">Project Index</a></li>
        <li><a href="#">Documentation</a></li>
        <li><a href="#">Contributing</a></li>
      </ul>
    </div>
    <div class="bulma-column">
      <ul>
        <li><a href="../code-of-conduct/">Code of Conduct</a></li>
        <li><a href="../security.html">Security Policy</a></li>
        <li><a href="#">Colophon</a></li>
      </ul>
    </div>
  </div>
  <div class="bulma-has-text-centered">
    <div>Find us on ...</div>
    <div>
      <a class="bulma-icon bulma-is-large bulma-has-text-current" href="https://github.com/typelevel">
        <i class="fab fa-github fa-2x"></i>
      </a>
      <a class="bulma-icon bulma-is-large bulma-has-text-current" href="https://discord.gg/pey2hnSQGS">
        <i class="fab fa-discord fa-2x"></i>
      </a>
      <a class="bulma-icon bulma-is-large bulma-has-text-current" href="https://bsky.app/profile/typelevel.org">
        <i class="fab fa-bluesky fa-2x"></i>
      </a>
      <a class="bulma-icon bulma-is-large bulma-has-text-current" href="https://fosstodon.org/@typelevel">
        <i class="fab fa-mastodon fa-2x"></i>
      </a>
      <a class="bulma-icon bulma-is-large bulma-has-text-current" href="https://www.youtube.com/@typelevel">
        <i class="fab fa-youtube fa-2x"></i>
      </a>
      <a class="bulma-icon bulma-is-large bulma-has-text-current"
        href="https://linkedin.com/company/typelevel-foundation">
        <i class="fab fa-linkedin fa-2x"></i>
      </a>
    </div>
  </div>
</footer>

</body>

</html>

